{"data":{"site":{"siteMetadata":{"title":"stackcheats"}},"markdownRemark":{"id":"a6770029-0b62-5639-b15f-dc6c444ff880","excerpt":"Docker: Postgres Pull Prerequisites: Docker installed in your environment. You can follow the  Docker  docs to get it done. Follow the given steps to set up…","html":"<h2>Docker: Postgres</h2>\n<h3>Pull</h3>\n<blockquote>\n<p>Prerequisites: Docker installed in your environment. You can follow the <a href=\"https://www.docker.com/get-started\">Docker</a> docs to get it done.</p>\n</blockquote>\n<p>Follow the given steps to set up Postgres using Docker in your dev environments. For this demo, we will be using <strong>Postgres - 9.6.14</strong> and <strong>WSO2 Identity Server 5.7</strong>.</p>\n<p>Start the Docker service and execute the following command to pull the Postgres (9.6.14) image from DockerHub</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker pull postgres:9.6.14</code></pre></div>\n<h3>Run</h3>\n<p>After a successful pull, execute the below command to create and run a docker container for our pulled Postgres image. Replace the <code class=\"language-text\">&lt;CONTAINER_NAME&gt;</code> tag with your preferred name.</p>\n<blockquote>\n<p>You can change the Postgres password by changing the <code class=\"language-text\">POSTGRES_PASSWORD</code> value from <code class=\"language-text\">hydrogen</code> to any preferred secured password</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker run --name &lt;CONTAINER_NAME&gt; -e POSTGRES_PASSWORD=hydrogen -p 5432:5432 -d -v $HOME/docker/volumes/postgres:/var/lib/postgresql postgres:9.6.14</code></pre></div>\n<blockquote>\n<p>Basic commands to <code class=\"language-text\">start</code> and <code class=\"language-text\">stop</code> a Docker container</p>\n<ul>\n<li><code class=\"language-text\">docker start &lt;CONTAINER_NAME&gt;</code> is used to start a container and</li>\n<li><code class=\"language-text\">docker stop &lt;CONTAINER_NAME&gt;</code> to stop a running container</li>\n</ul>\n</blockquote>\n<h3>PSQL</h3>\n<p>Use the following command to jump into the PSQL terminal session</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker exec -ti &lt;CONTAINER_NAME&gt; psql -h &lt;HOST&gt; -U &lt;USERNAME&gt;</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker exec -ti postgres-container psql -h localhost -U postgres</code></pre></div>\n<h2>Configurations</h2>\n<h3>Postgres</h3>\n<p>To replace the default packaged H2 database with Postgres, initially, we have to create the databases and tables in Postgres. Find and execute the following PostgreSQL scripts to create and set up all necessary tables and indexes.</p>\n<blockquote>\n<p>You can use either any database tools like DBeaver or you can straightaway execute them using PSQL terminal</p>\n</blockquote>\n<ul>\n<li><code class=\"language-text\">&lt;IS&gt;/dbscripts/postgresql.sql</code></li>\n<li><code class=\"language-text\">&lt;IS&gt;/dbscripts/identity/postgresql.sql</code></li>\n<li><code class=\"language-text\">&lt;IS&gt;/dbscripts/identity/uma/postgresql.sql</code></li>\n<li><code class=\"language-text\">&lt;IS&gt;/dbscripts/identity/stored-procedures/postgre/postgresql.sql</code></li>\n<li><code class=\"language-text\">&lt;IS&gt;/dbscripts/consent/postgresql.sql</code></li>\n</ul>\n<h3>WSO2 Identity Server</h3>\n<p>After setting up the databases, tables and indexes, now we have to install the Postgres JDBC connector (driver) inside our WSO2 Identity Server.\nDownload the Postgres driver from <a href=\"https://jdbc.postgresql.org/download.html\">here</a>, and place it inside the <code class=\"language-text\">&lt;IS&gt;/repository/components/lib</code> directory.</p>\n<p>Now, we have to configure our database connection settings in the Identity Server to connect to the Postgres. Make changes to the following XML files to change the connection from default H2 database to our newly created Postgres database.</p>\n<ul>\n<li><a href=\"#master-datasource\"><code class=\"language-text\">&lt;IS&gt;/repository/conf/datasources/master-datasources.xml</code></a></li>\n<li><a href=\"#identity\"><code class=\"language-text\">&lt;IS&gt;/repository/conf/identity/identity.xml</code></a></li>\n<li><a href=\"#registry\"><code class=\"language-text\">&lt;IS&gt;/repository/conf/registry.xml</code></a></li>\n</ul>\n<blockquote>\n<p>We will be changing the user store from the default LDAP server to the JDBC store</p>\n</blockquote>\n<ul>\n<li><a href=\"#user-management\"><code class=\"language-text\">&lt;IS&gt;/repository/conf/user-mgt.xml</code></a></li>\n</ul>\n<blockquote>\n<p>The following configurations and xml snippets have template connection strings. For example: <code class=\"language-text\">jdbc:postgresql://{host | localhost}:{port | 5432}/wso2carbon</code>. Replace and change the <code class=\"language-text\">host</code> and <code class=\"language-text\">port</code> segments with respective values.</p>\n</blockquote>\n<h4>Master DataSource</h4>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token comment\">&lt;!-- master-datasources.xml --></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>datasource</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>name</span><span class=\"token punctuation\">></span></span>WSO2_CARBON_POSTGRES_DB<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>name</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>description</span><span class=\"token punctuation\">></span></span>The datasource used for registry and user manager<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>description</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>jndiConfig</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>name</span><span class=\"token punctuation\">></span></span>jdbc/WSO2CarbonPostgresDB<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>name</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>jndiConfig</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>definition</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>RDBMS<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>configuration</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>url</span><span class=\"token punctuation\">></span></span>jdbc:postgresql://{host | localhost}:{port | 5432}/wso2carbon<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>url</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>username</span><span class=\"token punctuation\">></span></span>{username | postgres}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>username</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>password</span><span class=\"token punctuation\">></span></span>{password | hydrogen}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>password</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>driverClassName</span><span class=\"token punctuation\">></span></span>org.postgresql.Driver<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>driverClassName</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>maxActive</span><span class=\"token punctuation\">></span></span>80<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>maxActive</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>maxWait</span><span class=\"token punctuation\">></span></span>60000<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>maxWait</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>minIdle</span><span class=\"token punctuation\">></span></span>5<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>minIdle</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>testOnBorrow</span><span class=\"token punctuation\">></span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>testOnBorrow</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>validationQuery</span><span class=\"token punctuation\">></span></span>SELECT 1; COMMIT<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>validationQuery</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>defaultAutoCommit</span><span class=\"token punctuation\">></span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>defaultAutoCommit</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>validationInterval</span><span class=\"token punctuation\">></span></span>30000<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>validationInterval</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>configuration</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>definition</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>datasource</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h4>Identity</h4>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token comment\">&lt;!-- identity.xml --></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>JDBCPersistenceManager</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DataSource</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token comment\">&lt;!-- Include a data source name (jndiConfigName) from the set of data\n                sources defined in master-datasources.xml --></span>\n            <span class=\"token comment\">&lt;!-- &lt;Name>jdbc/WSO2CarbonDB&lt;/Name> --></span>\n\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Name</span><span class=\"token punctuation\">></span></span>jdbc/WSO2CarbonPostgresDB<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Name</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DataSource</span><span class=\"token punctuation\">></span></span>\n        ...</code></pre></div>\n<h4>Registry</h4>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token comment\">&lt;!-- registry.xml --></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dbConfig</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>wso2registry<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dataSource</span><span class=\"token punctuation\">></span></span>jdbc/WSO2CarbonDB<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dataSource</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dbConfig</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dbConfig</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>govregistry<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dataSource</span><span class=\"token punctuation\">></span></span>jdbc/WSO2CarbonPostgresDB<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dataSource</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dbConfig</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>remoteInstance</span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>https://{host | localhost}:{port | 9443|/registry<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>id</span><span class=\"token punctuation\">></span></span>gov<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>id</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>cacheId</span><span class=\"token punctuation\">></span></span>{username | postgres}@jdbc:postgresql://{host | localhost}:{port | 5432}/wso2carbon<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>cacheId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dbConfig</span><span class=\"token punctuation\">></span></span>govregistry<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dbConfig</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>readOnly</span><span class=\"token punctuation\">></span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>readOnly</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>enableCache</span><span class=\"token punctuation\">></span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>enableCache</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>registryRoot</span><span class=\"token punctuation\">></span></span>/<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>registryRoot</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>remoteInstance</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>mount</span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/_system/governance<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">overwrite</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>instanceId</span><span class=\"token punctuation\">></span></span>gov<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>instanceId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>targetPath</span><span class=\"token punctuation\">></span></span>/_system/governance<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>targetPath</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>mount</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>mount</span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/_system/config<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">overwrite</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>instanceId</span><span class=\"token punctuation\">></span></span>gov<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>instanceId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>targetPath</span><span class=\"token punctuation\">></span></span>/_system/config<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>targetPath</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>mount</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h4>User Management</h4>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Configuration</span><span class=\"token punctuation\">></span></span>\n    ...\n    <span class=\"token comment\">&lt;!-- &lt;Property name=\"dataSource\">jdbc/WSO2CarbonDB&lt;/Property> --></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>dataSource<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>jdbc/WSO2CarbonPostgresDB<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Property</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Configuration</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Comment the LDAP User-Store-Manager configurations and uncomment the JDBC User-Store-Manager. This will change our default LDAP user store with JDBC user store.</p>","frontmatter":{"title":"Replace H2 with Postgres","intro":"WSO2 Identity Server (5.7): Replace Default H2 DB with Postgres DB","tags":["wso2","wso2-identity-server","h2","postgres"],"author":"Athiththan"}}},"pageContext":{"slug":"/Replace-H2-with-Postgres/","node_id":"a6770029-0b62-5639-b15f-dc6c444ff880","nodePath":"/Replace-H2-with-Postgres/","nodeType":"sheet","title":"Replace H2 with Postgres","category":"WSO2","weight":-1,"updated":"2019-07-21T00:00:00.000Z","author":"Athiththan","short":"Guide to replace H2 with Postgres DB","tags":["wso2","wso2-identity-server","h2","postgres"]}}