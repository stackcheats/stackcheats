{"componentChunkName":"component---src-templates-blog-post-js","path":"/preserve-authorization-header/content/","result":{"data":{"site":{"siteMetadata":{"title":"StackCheats","author":"Athiththan Kathirgamasegaran"}},"mdx":{"id":"210be11e-abd1-5cf9-9657-9638f0e72f21","excerpt":"Greetings Everyone!!! üëã In this medium, I will be walking-through a solution to preserve and send the Authorization Header to the Backend service at the (per‚Ä¶","frontmatter":{"title":"Preserve Authorization Header in WSO2 API Manager","date":"April 03, 2021","intro":"Preserve and Send the Authorization Header to Backend Services","tags":["wso2","wso2-api-manager","handlers"],"seo":"A guide on preserving and sending the Authorization Header to backend services in WSO2 API Manager using custom handlers","medium":"https://athiththan11.medium.com/preserve-authorization-header-in-wso2-api-manager-e9469e43d1c0"},"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Preserve Authorization Header in WSO2 API Manager\",\n  \"date\": \"2021-04-03\",\n  \"intro\": \"Preserve and Send the Authorization Header to Backend Services\",\n  \"short\": \"Preserve and Send the Authorization Header to Backend Services\",\n  \"medium\": \"https://athiththan11.medium.com/preserve-authorization-header-in-wso2-api-manager-e9469e43d1c0\",\n  \"tags\": [\"wso2\", \"wso2-api-manager\", \"handlers\"],\n  \"seo\": \"A guide on preserving and sending the Authorization Header to backend services in WSO2 API Manager using custom handlers\",\n  \"bgcolor\": \"#c9daf8\"\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar Reference = makeShortcode(\"Reference\");\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h2\", {\n    \"id\": \"Greetings-Everyone-\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#Greetings-Everyone-\",\n    \"aria-label\": \"Greetings Everyone  permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Greetings Everyone!!! \\uD83D\\uDC4B\"), mdx(\"p\", null, \"In this medium, I will be walking-through a solution to preserve and send the Authorization Header to the Backend service at the (per) API level.\"), mdx(\"p\", null, \"APIs that are published through the WSO2 API Manager is protected by either OAuth2, Basic, or API Key tokens. As out-of-the-box, the API Manager server removes the incoming Authorization Header during the token validation process, so that the Backend services will never know the actual Access Token used to invoke the API in the API Manager.\"), mdx(\"p\", null, \"The API Manager has a global configuration to enable and disable the removal of the Authorization Header. The configuration can be found under the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"api-manager.xml\"), \" of the API Manager server.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-xml\"\n  }, \"<RemoveOAuthHeadersFromOutMessage>true</RemoveOAuthHeadersFromOutMessage>\\n\")), mdx(\"p\", null, \"and the respective TOML configuration will be as following\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-toml\"\n  }, \"[apim.oauth_config]\\nenable_outbound_auth_header = false\\n\")), mdx(\"p\", null, \"But, let\\u2019s say, we have a requirement, where we only need to pass the Authorization Header presented for a specific API and not for others. In such scenarios, as out-of-the-box, there is no direct solution to achieve this requirement. So, let\\u2019s see how we can achieve this requirement with minimal customizations.\"), mdx(\"p\", null, \"To make it easy, I have already developed a custom handler to extract and preserve the Authorization header in the message context. Given below is the custom handler implementation to preserve the Authorization header in the message context and then to pass it to the Backend service with the help of a mediation sequence.\"), mdx(\"p\", null, \"Let\\u2019s get more understanding on how they work\\u2026\"), mdx(Reference, {\n    title: \"Preserve Auth Header Handler\",\n    description: \"A Custom Handler to Preserve and Pass the Auth Header to BE in WSO2 APIM\",\n    hyperlink: \"https://github.com/athiththan11/Preserve-Auth-Header-Handler\",\n    mdxType: \"Reference\"\n  }), mdx(\"h2\", {\n    \"id\": \"-How-does-it-work\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#-How-does-it-work\",\n    \"aria-label\": \" How does it work permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"\\u270B How does it work?\"), mdx(\"p\", null, \"The custom handler is implemented to engage and extract the Authorization header during an API invocation through the WSO2 API Manager Gateway. The handler extracts the Authorization header from the Transport Headers and saves it to the Message Context with a custom Key-Value pair.\"), mdx(\"p\", null, \"Then, a global-in-mediation-sequence is added to the Gateway node, to check whether the custom Key-Value pair exists in the context. If exists, the value is retrieved from the context and set back as an Authorization header, and sent to the Backend service.\"), mdx(\"p\", null, \"You can find a sample global-in mediation sequence under the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"example\"), \" directory of the above-shared repository \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/athiththan11/Preserve-Auth-Header-Handler/blob/main/example/global--in.xml\"\n  }, \"Global Sequence\"), \". \\uD83D\\uDC4C\"), mdx(\"h2\", {\n    \"id\": \"-Configure-API-Manager\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#-Configure-API-Manager\",\n    \"aria-label\": \" Configure API Manager permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"\\u270B Configure API Manager\"), mdx(\"p\", null, \"Let\\u2019s go through how to configure the WSO2 API Manager to engage this handler and perform the trick.\"), mdx(\"p\", null, \"First, clone the shared repository, and build the project using the following command\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"The repository contains the source and dependencies supported to WSO2 API Manager v3.1.0\")), mdx(Reference, {\n    title: \"Preserve Auth Header Handler\",\n    description: \"A Custom Handler to Preserve and Pass the Auth Header to BE in WSO2 APIM\",\n    hyperlink: \"https://github.com/athiththan11/Preserve-Auth-Header-Handler\",\n    mdxType: \"Reference\"\n  }), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-shell\"\n  }, \"mvn clean package\\n\")), mdx(\"p\", null, \"Once, the build is done successfully, copy the built JAR artifact from the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"<project>/target\"), \" directory and place it inside \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"<apim>/repository/components/lib\"), \" directory.\"), mdx(\"p\", null, \"Next, we have to configure the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"velocity_template.xml\"), \" of the API Manager to engage the handler when the API is published to the Gateway nodes. To do so, we need to alter the existing \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"<apim>/repository/resources/api_templates/velocity_template.xml\"), \" with the following segment.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-xml\"\n  }, \"...\\n<handlers xmlns=\\\"http://ws.apache.org/ns/synapse\\\">\\n#foreach($handler in $handlers)\\n  #if($handler.className == 'org.wso2.carbon.apimgt.gateway.handlers.security.APIAuthenticationHandler')      \\n    #if($apiObj.additionalProperties.get('PreserveAuthHeader') == true)\\n    <handler class=\\\"com.sample.handlers.PreserveAuthHeaderHandler\\\">            \\n    #if($handler.hasProperties())\\n    #set ($tempMap = $handler.getProperties() )\\n      #foreach($property in $tempMap.entrySet())\\n        #if($property.key == 'AuthorizationHeader')\\n        <property name=\\\"$!property.key\\\" value=\\\"$!property.value\\\" />                \\n        #end\\n      #end\\n    #end\\n    </handler>\\n    #end\\n  #end\\n...\\n\")), mdx(\"p\", null, \"The above-segment introduces a condition to check whether an API Custom Property has been introduced with the name of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"PreserveAuthHeader\"), \". If yes, then the custom handler will be engaged and listed under the handlers section along with the default shipped handlers.\"), mdx(\"p\", null, \"Next, we have to add a global-in mediation sequence to read the custom key-value pair property from the context and to set the Authorization header back. Given below is a sample global-in mediation sequence and you can find the exact sequence inside the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"example\"), \" directory of the shared repository.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-xml\"\n  }, \"<sequence xmlns=\\\"http://ws.apache.org/ns/synapse\\\" name=\\\"WSO2AM--Ext--In\\\">\\n  <!-- a custom log to print the header content -->\\n  <log level=\\\"custom\\\">\\n    <property name=\\\"Extracted Auth Header\\\" \\nexpression=\\\"get-property('PRESERVE_AUTH_HEADER_HANDLER_TOKEN')\\\" />\\n  </log>\\n  <!-- setting back the Auth header if property exists-->\\n  <filter \\n    xpath=\\\"get-property('PRESERVE_AUTH_HEADER_HANDLER_TOKEN')\\\">\\n    <property name=\\\"Authorization\\\" scope=\\\"transport\\\" expression=\\\"get-property('PRESERVE_AUTH_HEADER_HANDLER_TOKEN')\\\" />     \\n  </filter>\\n</sequence>\\n\")), mdx(\"p\", null, \"Once the configurations are done, start the API Manager server and perform the following\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Log-in to the Publisher portal\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Create a new API or edit an existing API that needs to pass the Authorization header to the Backend\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Navigate to the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Properties\"), \" menu of the respective API and add the following custom property\", mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"PreserveAuthHeader\"), \" : \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"true\")))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"And save the API\")), mdx(\"p\", null, \"With the above-made configurations, now we will be able to see that our custom handler getting engaged with the respective API.\"), mdx(\"p\", null, \"We can verify this by navigating to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"<apim>/repository/deployment/server/syanpse-configs/default/api\"), \" directory and opening up the respective API Synapse artifact. There, under the handlers section, our custom \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"PreserveAuthHandler\"), \" will be engaged prior to the default \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"APIAuthenticationHandler\"), \".\"), mdx(\"h2\", {\n    \"id\": \"Voila---\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#Voila---\",\n    \"aria-label\": \"Voila    permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Voila!!! \\uD83C\\uDF89 \\uD83C\\uDF8A \\uD83C\\uDF89\"), mdx(\"p\", null, \"We have now successfully configured the API Manager server to preserve and send the Authorization header to the Backend service (per) API level.\"), mdx(\"h2\", {\n    \"id\": \"Happy-Stacking-\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#Happy-Stacking-\",\n    \"aria-label\": \"Happy Stacking  permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Happy Stacking!!! \\uD83D\\uDE0E\"));\n}\n;\nMDXContent.isMDXComponent = true;"},"sheetViews":null},"pageContext":{"slug":"/preserve-authorization-header/content/","previous":{"id":"e0156ef3-ceca-5c64-859f-f7da1143b16d","fields":{"slug":"/token-revocation-wso2-api-manager-keycloak/content/"},"frontmatter":{"title":"Token Revocation: WSO2 API Manager & Keycloak¬†KM"},"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Token Revocation: WSO2 API Manager & Keycloak¬†KM\",\n  \"date\": \"2020-11-18\",\n  \"intro\": \"Immediate Token (Cache) Revocation & Notifications in WSO2 API Manager with Keycloak as¬†KM\",\n  \"short\": \"Immediate Token (Cache) Revocation & Notifications\",\n  \"medium\": \"https://medium.com/@athiththan11/token-revocation-wso2-api-manager-keycloak-km-3695d217bd7c\",\n  \"tags\": [\"wso2\", \"wso2-api-manager\", \"keycloak\", \"token-revocation\"],\n  \"seo\": \"Immediate Token (cache) Revocation & Notification flow in WSO2 API Manager v3.2.0 with Keycloak configured as Key Manager\",\n  \"cover\": \"cover.png\",\n  \"bgcolor\": \"#d0e0e3\"\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar Reference = makeShortcode(\"Reference\");\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h2\", {\n    \"id\": \"Greetings-Everyone-\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#Greetings-Everyone-\",\n    \"aria-label\": \"Greetings Everyone  permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Greetings Everyone!!! \\uD83D\\uDC4B\"), mdx(\"p\", null, \"In this blog, I will be presenting a custom implementation to achieve the Immediate Token (cache) Revocation in WSO2 API Manager v3.2.0 with Keycloak configured as Key Manager.\"), mdx(\"p\", null, \"As you all may aware, \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, mdx(\"a\", {\n    parentName: \"strong\",\n    \"href\": \"https://apim.docs.wso2.com/en/3.2.0/\"\n  }, \"WSO2 API Manager v3.2.0\")), \" got released!!! \\uD83C\\uDF89\\uD83C\\uDF8A\\uD83C\\uDF89 \", mdx(\"br\", null), \"and it is packed with a lot of new features and functionalities to support various use-cases and requirements. One of the praised features is the immediate Token (cache) revocation.\\xA0\"), mdx(\"p\", null, \"The API Manager v3.2.0 now also supports configuring third-party Key Managers with less hassle through the Admin portal. You can learn more about the out-of-the-box key-manager connectors and the respective instructions below.\"), mdx(Reference, {\n    title: \"Overview - WSO2 API Manager Key Managers\",\n    description: \"Multiple Key Manager Support in WSO2 API Manager\",\n    hyperlink: \"https://apim.docs.wso2.com/en/3.2.0/administer/key-managers/overview/\",\n    mdxType: \"Reference\"\n  }), mdx(Reference, {\n    title: \"Configure a Third-Party Key Manager\",\n    description: \"Configure third-party Key Managers in WSO2 API Manager\",\n    hyperlink: \"https://apim.docs.wso2.com/en/3.2.0/install-and-setup/setup/distributed-deployment/configure-a-third-party-key-manager/\",\n    mdxType: \"Reference\"\n  }), mdx(\"p\", null, \"As out-of-the-box, the Token cache revocation is supported by the WSO2 API Manager when using the in-built Resident Key Manager or when using the WSO2 Identity Server as Key Manager. But, this feature was made as an extension to other supported Key Managers to achieve the requirement if required.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"You can learn more about the default Token (cache) Revocation flow the WSO2 API Manager v3.2.0 at \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://stackcheats.github.io/token-revocation/content/\"\n  }, \"Token Revocation\"))), mdx(\"p\", null, \"Hence, in this writing, we will be going through a sample implementation on achieving the Token (cache) revocation feature with Keycloak & WSO2 API Manager.\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Let\\u2019s get started\\xA0\\u2026\")), mdx(\"h2\", {\n    \"id\": \"-Implementation--Execution-Flow\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#-Implementation--Execution-Flow\",\n    \"aria-label\": \" Implementation  Execution Flow permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"\\u270B Implementation & Execution Flow\"), mdx(\"p\", null, \"First, let me brief you on the presented implementation and the requirement around it and then will explain how it works.\"), mdx(\"p\", null, \"The custom implementation is an extension for the Keycloak server to introduce and expose a custom Token Revocation endpoint. The extension implements the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"RealmResourceProvider\"), \" to expose the custom revocation endpoint per Realm basis.\"), mdx(\"p\", null, \"You may wonder why a custom revocation endpoint is needed in the Keycloak server; Well, Keycloak\\u2019s default Revocation endpoint only supports revoking the Refresh tokens and not the JWT Access Tokens.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"The above-statement is made considering the Keycloak v11 as the latest version in the community while delivering this blog \\uD83D\\uDE03\")), mdx(\"p\", null, \"The best-practice and security measure followed by the Keycloak community is to generate JWT Access Tokens with smaller validity.\\xA0\"), mdx(\"p\", null, \"But let\\u2019s assume that we have a requirement and we need to generate tokens with an hour validity. Further, the JWT tokens can be revoked by the client, and once the token is revoked the API Manager Gateway nodes needs to be aware of these in order to block the API requests that are associated with them.\"), mdx(\"p\", null, \"Hence, to achieve the above requirement, I have come up with an extension introducing a custom revoke endpoint to verify the JWT and to send the notifications to the API Manager servers.\"), mdx(\"p\", null, \"If you are eager to try out the solution, the complete source and instructions on applying those are available in the following Git repository \\uD83D\\uDC4F \\uD83D\\uDC4F \\uD83D\\uDC4C\"), mdx(Reference, {\n    title: \"Token Revocation Resource\",\n    description: \"A sample Keycloak RealmResourceProvider implementation to revoke the Token Caches in WSO2 API Manager\",\n    hyperlink: \"https://github.com/athiththan11/Token-Revocation-Resource\",\n    mdxType: \"Reference\"\n  }), mdx(\"p\", null, \"Let\\u2019s get some more insights into the execution flow and the data flow of our custom implementation to understand the complete picture of the solution.\"), mdx(\"p\", null, \"Given below is the HTTP definition of our custom Token Revocation endpoint in the Keycloak.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"{realm-name}\"), \" needs to be replaced with the realm name of the Keycloak that you are using to generate the JWT Tokens. Basically the Realm of the Keycloak clietns presented\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-http\"\n  }, \"POST /auth/realms/{realm-name}/revoke-token\\nAuthorization: Basic (base64<consumerkey:consumersecret>)\\nContent-Type: application/x-www-form-urlencoded\\n\\ntoken=<JWTToken>\\n\")), mdx(\"p\", null, \"As soon our custom revocation endpoint receives a request with an active JWT token, the endpoint (implementation) verifies the passed JWT token\\u2019s signature, and validity.\"), mdx(\"p\", null, \"If the token is found active and not expired, the following data are extracted from the presented JWT token to send the notification to the API Manager\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"JTI: JWT Token Identifier\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Expiry Time of the token\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Consumer Key\")), mdx(\"br\", null), mdx(\"p\", null, \"\\uD83D\\uDC49 Once the required data are extracted, those are composed and passed to the Event Sender to publish them to the Traffic Manager node. The data publishing is handled asynchronously and it is done by invoking the newly introduced Notification endpoint of Internal API of the Traffic Manager node.\"), mdx(\"p\", null, \"Please find the HTTP definition of the Notification endpoint of the Traffic Manager node which is called from our custom extension\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-http\"\n  }, \"POST /internal/data/v1/notify\\nHost: traffic-manager:9443\\nAuthorization: Basic (base64<username:password>)\\nContent-Type: application/json\\n\\n{\\n  \\\"accessToken\\\": <JTI>,\\n  \\\"expiryTime\\\": <expiry time>,\\n  \\\"user\\\": <username>,\\n  \\\"tokenType\\\": \\\"JWT\\\",\\n  \\\"timeStamp\\\": <current timestamp>,\\n  \\\"type\\\": \\\"token_revocation\\\",\\n  \\\"tenantId\\\": -1234,\\n  \\\"tenantDomain\\\": \\\"carbon.super\\\",\\n  \\\"consumerKey\\\": <consumer key>,\\n  \\\"eventId\\\": <random UUID>\\n}\\n\")), mdx(\"p\", null, \"Once the Traffic Manager receives the request, the data is sent to the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"strong\"\n  }, \"Token Revocation JMS Event Publisher\")), \" through a set of pre-defined \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"strong\"\n  }, \"Event Streams\")), \" deployed in the Traffic Manager server. And from the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"strong\"\n  }, \"Event Publisher\")), \", a Token Revocation message is pushed to all subscribed Gateway nodes to mark the specific JTI (JWT) as revoked.\"), mdx(\"p\", null, \"The Gateway node processes the received JMS message and persists the JTI record along with the Token expiry value in a temporary map named RevokedJWTDataHolder and clears the respective token entries from all other Token caches of the Gateway. This process ensures that the Gateway to not allow API requests if any of the revoked JWT tokens are used.\"), mdx(\"br\", null), mdx(\"p\", null, \"I know that it is hard to visualize the flow that I have explained above in my own words \\uD83D\\uDE15 \\uD83D\\uDE1F\\xA0\\u2026\\xA0\", mdx(\"br\", null), \"But, I believe you all may be familiar with the following saying\"), mdx(\"br\", null), mdx(\"p\", {\n    className: \"text-center h2 text-muted\"\n  }, \"\\\"A Picture Speaks a Thousand Words\\\"\"), mdx(\"br\", null), mdx(\"p\", null, \"Therefore, I have created a high-level diagram plotting the communications and data flows between the servers and components for an easier understanding\\xA0\\u2026\\uD83D\\uDC4C \\uD83D\\uDC4F\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"/779b310a38d0b6f075c6b4d35c32a150/token-revocation-flow--keycloak.svg\",\n    \"alt\": \"Token Revocation Flow with Keycloak KM\"\n  })), mdx(\"h2\", {\n    \"id\": \"-Voila-\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#-Voila-\",\n    \"aria-label\": \" Voila  permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"\\uD83C\\uDF89 Voila!!!\\xA0\\uD83C\\uDF89\"), mdx(\"p\", null, \"Hope this blog presented you with a little bit of information and insight on the Token Revocation feature of the WSO2 API Manager and how possible it is to make an extension and to achieve them through other supported Key Managers. \\uD83D\\uDC4C\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Clone the source >  build >  deploy and test the scenarios\"), \" and share your experience\"), mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"As this is a custom implementation, there can be bugs. Warmly welcome your contributions to the Repo if you find anything that needs to be fixed or improved. Issues and PRs are welcome \\uD83D\\uDE03\")), mdx(\"h2\", {\n    \"id\": \"Happy-Stacking---Ô∏è\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#Happy-Stacking---%EF%B8%8F\",\n    \"aria-label\": \"Happy Stacking   Ô∏è permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Happy Stacking\\xA0!!!! \\uD83E\\uDD18\\xA0\\u270C\\uFE0F\"));\n}\n;\nMDXContent.isMDXComponent = true;"},"next":{"id":"0c200a19-2603-597b-859d-8ac8f2936365","fields":{"slug":"/throttling-troubleshooting-guide/content/"},"frontmatter":{"title":"Preview Deck | Troubleshoot Guide"},"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Preview Deck | Troubleshoot Guide\",\n  \"date\": \"2021-05-18\",\n  \"intro\": \"A Troubleshooting guide for Throttling\",\n  \"short\": \"Sample Reveal Content in StackCheats\",\n  \"tags\": [\"wso2\", \"reveal\", \"sample\"],\n  \"seo\": \"A sample reveal JS content\",\n  \"reveal\": true\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h1\", {\n    \"id\": \"-Preview-Deck\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h1\",\n    \"href\": \"#-Preview-Deck\",\n    \"aria-label\": \" Preview Deck permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"\\uD83D\\uDC4B Preview Deck\"), mdx(\"p\", null, \"\\u2014h\\u2014\"), mdx(\"h2\", {\n    \"id\": \"Troubleshoot-Throttling\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#Troubleshoot-Throttling\",\n    \"aria-label\": \"Troubleshoot Throttling permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Troubleshoot Throttling\"), mdx(\"p\", null, \"This reveal deck contains the fundamental steps and instructions to troubleshoot few well-known issues in API Throttling of WSO2 API Manager.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"This deck is drafted based on API Manager v3.2.0, however, this can referenced for v3.1.0, and v3.0.0 versions\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Move across the deck using either arrow key on the keyboard, of by clicking the arrow icons in the bottom-right corner\"))), mdx(\"p\", null, \"Let\\u2019s get started!!!\"), mdx(\"p\", null, \"reveal-note:\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Use the arrow keys (\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"up\"), \",\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"right\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"down\"), \", and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"left\"), \") on the keyboard to navigate through the deck\"), mdx(\"br\", null), mdx(\"br\", null), \"Press `o` to show an overview of the deck\", mdx(\"br\", null), mdx(\"br\", null), \"Press `f` for full-screen mode\"), mdx(\"p\", null, \"\\u2014h\\u2014\"), mdx(\"p\", null, \"Are you having any issues while publishing a (custom) policy from the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Admin\"), \" portal?\"), mdx(\"p\", null, \"If \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"yes\"), \", go through the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"below\"), \"-given steps to verify the configurations in your environment.\\nIf \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"no\"), \", move to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"right\"), \".\"), mdx(\"p\", null, \"\\u2014v\\u2014\"), mdx(\"p\", null, \"A probable cause for this behavior can be a misconfiguration of the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Service URL\"), \" of the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Policy Deployer\"), \". Open the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"<publisher>/repository/conf/deployment.toml\"), \" and validate the following\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-toml\"\n  }, \"[apim.throttling]\\nservice_url = \\\"https://tm-lb-hostname:9443/services/\\\"\\n\")), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"service_url\"), \" must point to the Traffic Manager\\u2019s \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"services\"), \" endpoint. This is used to publish and deploy the execution policies in Traffic Manager. If the endpoint is not reachable or misconfigured, there will be errors logged in the Publisher.\")), mdx(\"p\", null, \"\\u2014v\\u2014\"), mdx(\"p\", null, \"Further, if you are using different user credentials (\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"username\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"password\"), \") for each node, please perform the following configurations in the Publisher\\u2019s \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"deployment.toml\"), \" to authenticate with the Traffic Manager without any failures.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-toml\"\n  }, \"[apim.throttling.policy_deploy]\\nusername = \\\"traffic-manager-admin-username\\\"\\npassword = \\\"traffic-manager-admin-password\\\"\\n\")), mdx(\"p\", null, \"\\u2014h\\u2014\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"We assume that you don\\u2019t have any issues with creating or publishing (custom) policies from the Admin portal. But, experiencing inconsistent behavior during the runtime.\")), mdx(\"p\", null, \"If you are experiencing errors in the Gateway node during runtime, scroll \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"down\"), \". If not, move to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"right\"), \".\"), mdx(\"p\", null, \"reveal-note:\"), mdx(\"p\", null, \"Advanced Throttling enables an async communication between Gateway and Traffic Manager. During runtime, the Gateway collects and sends events to the Traffic Manager to process decisions.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"If the API resource is unsecured, a default \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Unauthenticated\"), \" subscription policy will be used to evaluate the subscription level throttling nevertheless the assigned.\")), mdx(\"p\", null, \"\\u2014v\\u2014\"), mdx(\"p\", null, \"Are you seeing any of the following error-traces in the Gateway node?\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"ERROR - DataEndpointConnectionWorker Error while trying to connect to the endpoint. Cannot borrow client for ssl://traffic-manager-host:9711\\norg.wso2.carbon.databridge.agent.exception.DataEndpointAuthenticationException: Cannot borrow client for ssl://traffic-manager-host:9711\\n    ...\\nCaused by: org.wso2.carbon.databridge.agent.exception.DataEndpointException: Error while opening socket to traffic-manager-host:9711. Connection refused (Connection refused)\\n    ...\\nCaused by: java.net.ConnectException: Connection refused (Connection refused)\\n\")), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Yes\"), \"? proceed \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"down\"), \".\"), mdx(\"p\", null, \"\\u2014v\\u2014\"), mdx(\"p\", null, \"The mentioned errors are logged due to connectivity issues between Gateway and Traffic Manager. Gateway establishes a Binary transport communication link with Traffic Manager to publish throttle data events.\"), mdx(\"p\", null, \"Check whether all required ports related to Binary communication (\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"9711\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"9611\"), \") are opened and not blocked by any firewall. You can use the following \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"telnet\"), \" from Gateway instance to check the connectivity between Traffic Manager.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-shell\"\n  }, \"telnet traffic-manager-host 9611\\n\")), mdx(\"p\", null, \"\\u2014h\\u2014\"), mdx(\"h2\", {\n    \"id\": \"Happy-Stacking-\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#Happy-Stacking-\",\n    \"aria-label\": \"Happy Stacking  permalink\",\n    \"className\": \"header-permlink before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"height\": \"20\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"20\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Happy Stacking!!! \\uD83D\\uDC4C\\uD83D\\uDC4C\\uD83D\\uDC4C\"));\n}\n;\nMDXContent.isMDXComponent = true;"}}},"staticQueryHashes":["2632472463"]}